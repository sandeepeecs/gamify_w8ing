var fs = require('fs');

var express = require('express');
var server =  express.createServer(); 
var nowjs = require("now");
var everyone = nowjs.initialize(server);

everyone.on("connect", function(){
  console.log("Joined: " + this.now.name);
});

everyone.on("disconnect", function(){
  console.log("Left: " + this.now.name);
});

everyone.now.distribute = function(message){
  everyone.now.receive(this.now.name, message);
};

server.use(server.router);
server.use(express.bodyParser());
server.use(express.static(__dirname + '/images'));

//server.register('.html', require('jade'));
var myArray = ['Face', 'LeftEye','RightEye','Mouth','Nose','Neck','Body','LeftHand','RightHand','LeftLeg','RightLeg'];
var cnt=0;

server.get('/', function(req, response){
fs.readFile(__dirname+'/index.html', function(err, data){
    response.writeHead(200, {'Content-Type':'text/html'});
    response.write(data);
    response.end();
});

//response.render(__dirname+'/index.html');
});


server.get('/realtime', function(req, res){
 //res.send('Event: ' + req.param('cid'));
   console.log("got request: " + req.param('event'));

 if(req.param('event') == "NewCall")
 {
	res.send('<response><playaudio>http://yourpbx.in/slot1.wav</playaudio></response>');
	everyone.now.receive("Start", "Ph:"+ req.param('cid'));
 }
 else if(req.param('event') == "Hangup")
 {
	res.send('<response><hangup/></response>');
	everyone.now.receive("Stop", "Ph:"+ req.param('cid'));
 }
 else if(req.param('event') == "Disconnect")
 {
	res.send('<response><hangup/></response>');
	everyone.now.receive("Stop", "Ph:"+ req.param('cid'));	
 }
 else
 {
	res.send('<response><playaudio>http://yourpbx.in/slot1.wav</playaudio></response>');
	 
 }

 	//everyone.now.receiveMessage(myArray[cnt++], "Ph:"+ req.param('cid'));
});
server.listen(8080);

